@using System.Globalization
@using System.Linq
@using CliCarProject.Models.Classes
@using Microsoft.AspNetCore.Mvc.Rendering

@model IEnumerable<Anuncio>

@{
    ViewData["Title"] = "Pesquisar Carros";

    var qSearchBox = (string?)Context.Request.Query["searchBox"];
    var qMarcaId = (string?)Context.Request.Query["marcaId"];
    var qModeloId = (string?)Context.Request.Query["modeloId"];
    var qCategoriaId = (string?)Context.Request.Query["categoriaId"];
    var qCombustivelId = (string?)Context.Request.Query["combustivelId"];
    var qCaixa = (string?)Context.Request.Query["caixa"];
    var qLocalizacaoId = (string?)Context.Request.Query["localizacaoId"];
    var currentSort = (string?)ViewBag.CurrentSort ?? "";

    var marcas = ViewBag.Marcas as List<Marca> ?? new List<Marca>();
    var modelos = ViewBag.Modelos as List<Modelo> ?? new List<Modelo>();
    var classes = ViewBag.Classes as List<Classe> ?? new List<Classe>();
    var combustiveis = ViewBag.Combustiveis as List<Combustivel> ?? new List<Combustivel>();
    var caixas = ViewBag.Caixas as List<SelectListItem> ?? new List<SelectListItem>();
    var localizacoes = ViewBag.Localizacoes as List<Localizacao> ?? new List<Localizacao>();
}

<div class="container py-5">
    <div class="row">

        <div class="col-lg-3 mb-4">
            <div class="search-box search-box-left">
                <form method="get" asp-controller="Car" asp-action="CarSearch" id="searchForm" class="search-box-vertical d-grid gap-2">

                    <input type="hidden" name="condicao" id="condicaoInput" value="@Context.Request.Query["condicao"]" />
                    <input name="searchBox" class="form-control" placeholder="Procurar..." value="@qSearchBox" />

                    <select class="form-select" name="localizacaoId">
                        <option value="">Todo o País</option>
                        @foreach (var loc in localizacoes)
                        {
                            <option value="@loc.IdLocalizacao" selected="@(qLocalizacaoId == loc.IdLocalizacao.ToString() ? "selected" : null)">@loc.Distrito</option>
                        }
                    </select>

                    <select class="form-select" name="marcaId" id="marcaId">
                        <option value="">Marca</option>
                        @foreach (var m in marcas)
                        {
                            <option value="@m.IdMarca" selected="@(qMarcaId == m.IdMarca.ToString() ? "selected" : null)">@m.Nome</option>
                        }
                    </select>

                    <select class="form-select" name="modeloId" id="modeloId" disabled>
                        <option value="">Modelo</option>
                        @foreach (var mo in modelos)
                        {
                            <option value="@mo.IdModelo" selected="@(qModeloId == mo.IdModelo.ToString() ? "selected" : null)">@mo.Nome</option>
                        }
                    </select>

                    <select class="form-select" name="categoriaId">
                        <option value="">Categoria</option>
                        @foreach (var c in classes)
                        {
                            <option value="@c.IdClasse" selected="@(qCategoriaId == c.IdClasse.ToString() ? "selected" : null)">@c.Nome</option>
                        }
                    </select>

                    <select class="form-select" name="combustivelId">
                        <option value="">Combustível</option>
                        @foreach (var cb in combustiveis)
                        {
                            <option value="@cb.IdCombustivel" selected="@(qCombustivelId == cb.IdCombustivel.ToString() ? "selected" : null)">@cb.Tipo</option>
                        }
                    </select>

                    <select class="form-select" name="caixa">
                        <option value="">Qualquer Caixa</option>
                        @foreach (var cx in caixas)
                        {
                            <option value="@cx.Value" selected="@(qCaixa == cx.Value ? "selected" : null)">@cx.Text</option>
                        }
                    </select>

                    <div>
                        <label class="form-label small text-muted mt-2">Preço (€)</label>
                        <div class="row g-1">
                            <div class="col-6"><input type="number" name="minPrice" class="form-control" placeholder="De" min="0" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@Context.Request.Query["minPrice"]" /></div>
                            <div class="col-6"><input type="number" name="maxPrice" class="form-control" placeholder="Até" min="0" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@Context.Request.Query["maxPrice"]" /></div>
                        </div>
                    </div>

                    <div>
                        <label class="form-label small text-muted mt-2">Ano</label>
                        <div class="row g-1">
                            <div class="col-6"><input type="number" name="minYear" class="form-control" placeholder="De" min="1900" max="2100" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@Context.Request.Query["minYear"]" /></div>
                            <div class="col-6"><input type="number" name="maxYear" class="form-control" placeholder="Até" min="1900" max="2100" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@Context.Request.Query["maxYear"]" /></div>
                        </div>
                    </div>

                    <div>
                        <label class="form-label small text-muted mt-2">Quilómetros</label>
                        <div class="row g-1">
                            <div class="col-6"><input type="number" name="minKm" class="form-control" placeholder="De" min="0" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@Context.Request.Query["minKm"]" /></div>
                            <div class="col-6"><input type="number" name="maxKm" class="form-control" placeholder="Até" min="0" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@Context.Request.Query["maxKm"]" /></div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-danger w-100 mt-3">Pesquisar</button>
                </form>
            </div>
        </div>

        <div class="col-lg-9">

            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">

                @{
                    var currentCond = (string?)ViewBag.CurrentCondicao ?? "";
                }
                <ul class="nav nav-tabs-custom">

                    <li class="nav-item">
                        <a href="#" class="nav-link filter-tab @(string.IsNullOrEmpty(currentCond) ? "active" : "")"
                           data-val="">Todos</a>
                    </li>

                    <li class="nav-item">
                        <a href="#" class="nav-link filter-tab @(currentCond == "U" ? "active" : "")"
                           data-val="U">Usados</a>
                    </li>

                    <li class="nav-item">
                        <a href="#" class="nav-link filter-tab @(currentCond == "S" ? "active" : "")"
                           data-val="S">Semi-novos</a>
                    </li>

                    <li class="nav-item">
                        <a href="#" class="nav-link filter-tab @(currentCond == "N" ? "active" : "")"
                           data-val="N">Novos</a>
                    </li>
                </ul>

                <div class="d-flex align-items-center">
                    <select name="sortOrder" class="form-select form-select-sm border-0 bg-light fw-bold" form="searchForm" style="width: auto; cursor:pointer;">
                        <option value="" selected="@(string.IsNullOrWhiteSpace(currentSort) ? "selected" : null)">Ordenar por...</option>
                        <option value="ano_desc" selected="@(currentSort == "ano_desc" ? "selected" : null)">Mais Recentes</option>
                        <option value="ano_asc" selected="@(currentSort == "ano_asc" ? "selected" : null)">Mais Antigos</option>
                        <option value="preco_asc" selected="@(currentSort == "preco_asc" ? "selected" : null)">Preço (Baixo)</option>
                        <option value="preco_desc" selected="@(currentSort == "preco_desc" ? "selected" : null)">Preço (Alto)</option>
                    </select>
                </div>
            </div>

            <div id="results-container">
                <partial name="_AnunciosGrid" model="Model" />
            </div>
        </div>
        </div>

    </div>
</div>

@section Scripts {
    <script>
        (function () {
            // --- VARIÁVEIS PRINCIPAIS ---
            const form = document.getElementById('searchForm');
            const resultsContainer = document.getElementById('results-container');
            const marcaSelect = document.getElementById('marcaId');
            const modeloSelect = document.getElementById('modeloId');
            const sortSelect = document.querySelector('select[name="sortOrder"]');
            const searchInput = form.querySelector('input[name="searchBox"]');
            const condicaoInput = document.getElementById('condicaoInput');

            const currentModeloId = "@qModeloId";
            let debounceTimer;

            // --- 1. LÓGICA DAS ABAS (NOVO/USADO) ---
            // Agora usamos "querySelectorAll" em vez de "onclick", é mais seguro.
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault(); // <--- IMPEDE O RECARREGAMENTO DA PÁGINA

                    // 1. Atualiza o input escondido
                    const valor = this.getAttribute('data-val');
                    if (condicaoInput) condicaoInput.value = valor;

                    // 2. Atualiza o visual (active)
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // 3. Dispara a pesquisa
                    fetchResults(1);
                });
            });

            // --- 2. LÓGICA DE MODELOS ---
            function setModelos(list) {
                modeloSelect.innerHTML = '<option value="">Modelo</option>';
                list.forEach(m => {
                    const id = m.idModelo ?? m.IdModelo;
                    const nome = m.nome ?? m.Nome;
                    const opt = document.createElement('option');
                    opt.value = id; opt.textContent = nome;
                    if (id == currentModeloId) opt.selected = true;
                    modeloSelect.appendChild(opt);
                });
                modeloSelect.disabled = list.length === 0;
            }

            // --- 3. AJAX PRINCIPAL (BUSCAR CARROS) ---
            function fetchResults(page = 1) {
                const formData = new FormData(form);
                if (sortSelect) formData.append('sortOrder', sortSelect.value);
                formData.append('page', page);

                const params = new URLSearchParams(formData).toString();
                const url = `${form.action}?${params}`;

                // window.history.pushState({}, '', url); // Opcional: muda o URL do browser
                resultsContainer.style.opacity = '0.5';

                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(r => r.text())
                .then(html => {
                    resultsContainer.innerHTML = html;
                    resultsContainer.style.opacity = '1';
                    attachPaginationEvents();
                })
                .catch(err => {
                    console.error(err);
                    resultsContainer.style.opacity = '1';
                });
            }

            // --- 4. LISTENERS (PESQUISA EM TEMPO REAL) ---

            // A. Pesquisa de Texto (Com atraso de 500ms)
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => fetchResults(1), 500);
                });
            }

            // B. Inputs Numéricos (Preço, Ano, Km)
            form.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => fetchResults(1), 600);
                });
            });

            // C. Dropdowns (Mudança imediata)
            marcaSelect.addEventListener('change', function () {
                const marcaId = this.value;
                if (!marcaId) {
                    modeloSelect.innerHTML = '<option value="">Modelo</option>';
                    modeloSelect.disabled = true;
                    fetchResults(1);
                    return;
                }
                fetch(`/Car/GetModelos?marcaId=${encodeURIComponent(marcaId)}`)
                    .then(r => r.json())
                    .then(data => { setModelos(data || []); fetchResults(1); });
            });

            form.querySelectorAll('select:not(#marcaId)').forEach(s => {
                s.addEventListener('change', () => fetchResults(1));
            });

            if (sortSelect) sortSelect.addEventListener('change', () => fetchResults(1));

            // D. Paginação
            function attachPaginationEvents() {
                document.querySelectorAll('.ajax-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const page = this.getAttribute('data-page');
                        fetchResults(page);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                });
            }

            // E. Prevenir submit tradicional do form (tecla Enter, etc)
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                fetchResults(1);
            });

            // --- 5. INICIALIZAÇÃO ---
            if (marcaSelect.value) {
                fetch(`/Car/GetModelos?marcaId=${encodeURIComponent(marcaSelect.value)}`)
                    .then(r => r.json()).then(d => setModelos(d || []));
            }
            attachPaginationEvents();

        })();
    </script>
}