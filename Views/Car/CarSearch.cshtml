@using System.Globalization
@using System.Linq
@using CliCarProject.Models.Classes
@using Microsoft.AspNetCore.Mvc.Rendering

@model IEnumerable<Anuncio>

@{
    ViewData["Title"] = "Pesquisar Carros";

    var qSearchBox = (string?)Context.Request.Query["searchBox"];
    var qMarcaId = (string?)Context.Request.Query["marcaId"];
    var qModeloId = (string?)Context.Request.Query["modeloId"];
    var qCategoriaId = (string?)Context.Request.Query["categoriaId"];
    var qCombustivelId = (string?)Context.Request.Query["combustivelId"];
    var qCaixa = (string?)Context.Request.Query["caixa"];
    var qLocalizacaoId = (string?)Context.Request.Query["localizacaoId"];

    var ocultarReservados = Context.Request.Query["ocultarReservados"] == "true";

    var currentSort = (string?)ViewBag.CurrentSort ?? "";
    var currentCond = (string?)ViewBag.CurrentCondicao ?? "";

    var marcas = ViewBag.Marcas as List<Marca> ?? new List<Marca>();
    var modelos = ViewBag.Modelos as List<Modelo> ?? new List<Modelo>();
    var classes = ViewBag.Classes as List<Classe> ?? new List<Classe>();
    var combustiveis = ViewBag.Combustiveis as List<Combustivel> ?? new List<Combustivel>();
    var caixas = ViewBag.Caixas as List<SelectListItem> ?? new List<SelectListItem>();
    var localizacoes = ViewBag.Localizacoes as List<Localizacao> ?? new List<Localizacao>();
}

<style>
    /* --- CSS PARA O SWITCH VERMELHO --- */
    .form-check-input:checked {
        background-color: #dc3545 !important;
        border-color: #dc3545 !important;
    }

    .form-check-input:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
    }

    /* CSS dos Cards */
    .car-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #eee;
        overflow: hidden;
    }

        .car-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
        }

    .car-card-img {
        height: 200px;
        width: 100%;
        object-fit: cover;
    }

    .spec-item {
        font-size: 0.85rem;
        color: #555;
        display: flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .price-tag {
        font-size: 1.25rem;
        font-weight: 800;
        color: #dc3545;
    }

    /* Uniformizar inputs da sidebar */
    .search-box-vertical .form-select,
    .search-box-vertical .form-control {
        font-size: 0.95rem;
        padding: 0.6rem 0.75rem;
    }
</style>

<div class="container-fluid mt-4 px-4">
    <div class="row">

        <div class="col-md-4 col-lg-3 mb-4 ps-0">
            <div class="search-box bg-white p-4 rounded shadow-sm border">

                <form method="get" asp-controller="Car" asp-action="CarSearch" id="searchForm" class="d-grid gap-3 search-box-vertical">

                    <input type="hidden" name="condicao" id="condicaoInput" value="@Context.Request.Query["condicao"]" />

                    <div>
                        <input name="searchBox" class="form-control" placeholder="Procurar..." value="@qSearchBox" />
                    </div>

                    <div class="form-check form-switch ps-0 d-flex align-items-center bg-light p-2 border rounded">
                        <input class="form-check-input ms-0 me-2" type="checkbox" id="switchReservados" name="ocultarReservados" value="true" @(ocultarReservados ? "checked" : "") style="cursor: pointer;">
                        <label class="form-check-label small fw-bold text-dark" for="switchReservados" style="cursor: pointer;">Ocultar Reservados</label>
                    </div>

                    <div class="d-grid gap-2">
                        <select class="form-select" name="localizacaoId">
                            <option value="">Todo o País</option>
                            @foreach (var loc in localizacoes)
                            {
                                <option value="@loc.IdLocalizacao" selected="@(qLocalizacaoId == loc.IdLocalizacao.ToString() ? "selected" : null)">@loc.Distrito</option>
                            }
                        </select>

                        <select class="form-select" name="marcaId" id="marcaId">
                            <option value="">Marca</option>
                            @foreach (var m in marcas)
                            {
                                <option value="@m.IdMarca" selected="@(qMarcaId == m.IdMarca.ToString() ? "selected" : null)">@m.Nome</option>
                            }
                        </select>

                        <select class="form-select" name="modeloId" id="modeloId" disabled>
                            <option value="">Modelo</option>
                            @foreach (var mo in modelos)
                            {
                                <option value="@mo.IdModelo" selected="@(qModeloId == mo.IdModelo.ToString() ? "selected" : null)">@mo.Nome</option>
                            }
                        </select>

                        <select class="form-select" name="categoriaId">
                            <option value="">Categoria</option>
                            @foreach (var c in classes)
                            {
                                <option value="@c.IdClasse" selected="@(qCategoriaId == c.IdClasse.ToString() ? "selected" : null)">@c.Nome</option>
                            }
                        </select>

                        <select class="form-select" name="combustivelId">
                            <option value="">Combustível</option>
                            @foreach (var cb in combustiveis)
                            {
                                <option value="@cb.IdCombustivel" selected="@(qCombustivelId == cb.IdCombustivel.ToString() ? "selected" : null)">@cb.Tipo</option>
                            }
                        </select>

                        <select class="form-select" name="caixa">
                            <option value="">Qualquer Caixa</option>
                            @foreach (var cx in caixas)
                            {
                                <option value="@cx.Value" selected="@(qCaixa == cx.Value ? "selected" : null)">@cx.Text</option>
                            }
                        </select>
                    </div>

                    <hr class="my-1 text-muted">

                    <div>
                        <label class="form-label small fw-bold text-muted mb-1">Preço (€)</label>
                        <div class="d-flex gap-2">
                            <input type="number" name="minPrice" class="form-control w-50" placeholder="De" min="0" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@Context.Request.Query["minPrice"]" />
                            <input type="number" name="maxPrice" class="form-control w-50" placeholder="Até" min="0" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@Context.Request.Query["maxPrice"]" />
                        </div>
                    </div>

                    <div>
                        <label class="form-label small fw-bold text-muted mb-1">Ano</label>
                        <div class="d-flex gap-2">
                            <input type="number" name="minYear" class="form-control w-50" placeholder="De" min="1900" max="2100" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@Context.Request.Query["minYear"]" />
                            <input type="number" name="maxYear" class="form-control w-50" placeholder="Até" min="1900" max="2100" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@Context.Request.Query["maxYear"]" />
                        </div>
                    </div>

                    <div>
                        <label class="form-label small fw-bold text-muted mb-1">Quilómetros</label>
                        <div class="d-flex gap-2">
                            <input type="number" name="minKm" class="form-control w-50" placeholder="De" min="0" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@Context.Request.Query["minKm"]" />
                            <input type="number" name="maxKm" class="form-control w-50" placeholder="Até" min="0" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@Context.Request.Query["maxKm"]" />
                        </div>
                    </div>

                    <div class="mt-2">
                        <label class="form-label small fw-bold text-muted mb-1">Pesquisas Guardadas</label>
                        <div class="d-flex align-items-center gap-2">
                            <div class="dropdown flex-grow-1">
                                <button class="form-select text-start text-truncate w-100 shadow-none"
                                        type="button"
                                        id="favoritesDropdownBtn"
                                        data-bs-toggle="dropdown"
                                        aria-expanded="false">
                                    <span id="favoritesLabel">-- Selecionar --</span>
                                </button>
                                <ul class="dropdown-menu w-100 shadow border-0" id="savedFiltersList" style="max-height: 300px; overflow-y: auto;"></ul>
                            </div>

                            <button type="button" class="btn btn-outline-secondary d-flex align-items-center justify-content-center"
                                    title="Gerir Favoritos"
                                    onclick="openManageFavorites()"
                                    style="width: 42px; height: 38px; flex-shrink: 0;">
                                🗑️
                            </button>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-danger w-100 mt-2 fw-bold">Pesquisar</button>
                    <button type="button" class="btn btn-outline-secondary w-100 btn-sm" data-bs-toggle="modal" data-bs-target="#saveFilterModal">⭐ Guardar Pesquisa</button>
                </form>
            </div>
        </div>

        <div class="col-md-8 col-lg-9">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                <ul class="nav nav-tabs-custom">
                    <li class="nav-item"><a href="#" class="nav-link filter-tab @(string.IsNullOrEmpty(currentCond) ? "active" : "")" data-val="">Todos</a></li>
                    <li class="nav-item"><a href="#" class="nav-link filter-tab @(currentCond == "U" ? "active" : "")" data-val="U">Usados</a></li>
                    <li class="nav-item"><a href="#" class="nav-link filter-tab @(currentCond == "S" ? "active" : "")" data-val="S">Semi-novos</a></li>
                    <li class="nav-item"><a href="#" class="nav-link filter-tab @(currentCond == "N" ? "active" : "")" data-val="N">Novos</a></li>
                </ul>

                <div class="d-flex align-items-center">
                    <select name="sortOrder" class="form-select form-select-sm border-0 bg-light fw-bold" form="searchForm" style="width: auto; cursor:pointer;">
                        <option value="" selected="@(string.IsNullOrWhiteSpace(currentSort) ? "selected" : null)">Ordenar por...</option>
                        <option value="ano_desc" selected="@(currentSort == "ano_desc" ? "selected" : null)">Mais Recentes</option>
                        <option value="ano_asc" selected="@(currentSort == "ano_asc" ? "selected" : null)">Mais Antigos</option>
                        <option value="preco_asc" selected="@(currentSort == "preco_asc" ? "selected" : null)">Preço (Baixo)</option>
                        <option value="preco_desc" selected="@(currentSort == "preco_desc" ? "selected" : null)">Preço (Alto)</option>
                    </select>
                </div>
            </div>

            <div id="results-container">
                <partial name="_AnunciosGrid" model="Model" />
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="saveFilterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0" style="border-radius: 12px;">
            <div class="modal-header border-0 pb-0 justify-content-center">
                <h5 class="modal-title fw-bold text-dark">Guardar Pesquisa</h5>
            </div>
            <div class="modal-body p-4">
                <label for="filterNameInput" class="form-label text-muted small fw-bold">NOME DA PESQUISA</label>
                <input type="text" id="filterNameInput" class="form-control form-control-lg bg-light" placeholder="Ex: BMW Série 1 Barato">
            </div>
            <div class="modal-footer border-0 pt-0 px-4 pb-4 d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary px-4 rounded-pill" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="btnGuardarFiltro" class="btn btn-primary px-4 rounded-pill">Guardar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="manageFavoritesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Gerir Favoritos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-2">
                <p class="text-muted small mb-3">Apaga as pesquisas que já não precisas.</p>
                <ul class="list-group list-group-flush" id="manageFavoritesList"></ul>
                <div id="emptyFavoritesMsg" class="text-center py-4 d-none">
                    <span class="text-muted">Não tens favoritos guardados.</span>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light w-100 rounded-pill" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const form = document.getElementById('searchForm');
            const resultsContainer = document.getElementById('results-container');
            const marcaSelect = document.getElementById('marcaId');
            const modeloSelect = document.getElementById('modeloId');
            const sortSelect = document.querySelector('select[name="sortOrder"]');
            const searchInput = form.querySelector('input[name="searchBox"]');
            const condicaoInput = document.getElementById('condicaoInput');
            const switchReservados = document.getElementById('switchReservados');
            const btnGuardar = document.getElementById('btnGuardarFiltro');
            const nameInput = document.getElementById('filterNameInput');
            const currentModeloId = "@qModeloId";
            let debounceTimer;

            function setModelos(list, selectedId = null) {
                if(!modeloSelect) return;
                modeloSelect.innerHTML = '<option value="">Modelo</option>';
                list.forEach(m => {
                    const id = m.idModelo ?? m.IdModelo;
                    const nome = m.nome ?? m.Nome;
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = nome;
                    if (id == selectedId || id == currentModeloId) opt.selected = true;
                    modeloSelect.appendChild(opt);
                });
                modeloSelect.disabled = list.length === 0;
            }

            function fetchResults(page = 1) {
                const formData = new FormData(form);
                if (sortSelect) formData.append('sortOrder', sortSelect.value);
                formData.append('page', page);
                if(switchReservados) { formData.set('ocultarReservados', switchReservados.checked); }
                const params = new URLSearchParams(formData).toString();
                const url = `${form.action}?${params}`;
                resultsContainer.style.opacity = '0.5';
                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(r => r.text())
                .then(html => {
                    resultsContainer.innerHTML = html;
                    resultsContainer.style.opacity = '1';
                    attachPaginationEvents();
                    window.history.pushState({path: url}, '', url);
                })
                .catch(err => { console.error(err); resultsContainer.style.opacity = '1'; });
            }

            function loadSavedFiltersList() {
                const listContainer = document.getElementById('savedFiltersList');
                if(!listContainer) return;
                fetch('/Car/ObterMeusFiltros').then(r => r.json()).then(data => {
                    listContainer.innerHTML = '';
                    const liReset = document.createElement('li');
                    liReset.innerHTML = `<button class="dropdown-item text-secondary fw-bold small" type="button" onclick="applyFavorite(null, '-- Selecionar Favorito --')">↺ Limpar Filtros</button>`;
                    listContainer.appendChild(liReset);
                    if(data.length > 0) listContainer.appendChild(document.createElement('hr')).className = "dropdown-divider my-1";
                    data.forEach(f => {
                        const li = document.createElement('li');
                        li.innerHTML = `<button class="dropdown-item text-truncate" type="button" data-json='${f.json}' onclick="applyFavorite(this, '${f.nome}')">${f.nome}</button>`;
                        listContainer.appendChild(li);
                    });
                });
            }

            window.openManageFavorites = function() {
                const modal = new bootstrap.Modal(document.getElementById('manageFavoritesModal'));
                modal.show();
                loadManageList();
            };

            function loadManageList() {
                const manageList = document.getElementById('manageFavoritesList');
                const emptyMsg = document.getElementById('emptyFavoritesMsg');
                manageList.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
                fetch('/Car/ObterMeusFiltros').then(r => r.json()).then(data => {
                    manageList.innerHTML = '';
                    if (data.length === 0) { emptyMsg.classList.remove('d-none'); } else {
                        emptyMsg.classList.add('d-none');
                        data.forEach(f => {
                            const li = document.createElement('li');
                            li.className = "list-group-item d-flex justify-content-between align-items-center py-3";
                            li.innerHTML = `<span class="fw-bold text-dark text-truncate me-2" style="max-width: 250px;">${f.nome}</span><button class="btn btn-outline-danger btn-sm px-3 rounded-pill" onclick="deleteFavoriteInModal(${f.id})">Apagar</button>`;
                            manageList.appendChild(li);
                        });
                    }
                });
            }

            window.deleteFavoriteInModal = function(id) {
                fetch('/Car/ApagarFiltro?id=' + id, { method: 'POST' }).then(r => r.json()).then(response => {
                    if(response.success) { loadManageList(); loadSavedFiltersList(); } else { alert("Erro: " + response.message); }
                });
            };

            window.applyFavorite = function(element, nome) {
                const btnLabel = document.getElementById('favoritesLabel');
                btnLabel.textContent = nome;
                if (!element) {
                    form.reset();
                    if(condicaoInput) condicaoInput.value = "";
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    document.querySelector('.filter-tab[data-val=""]')?.classList.add('active');
                    if(modeloSelect) { modeloSelect.innerHTML = '<option value="">Modelo</option>'; modeloSelect.disabled = true; }
                    fetchResults(1);
                    return;
                }
                const jsonString = element.getAttribute('data-json');
                const filters = JSON.parse(jsonString);
                form.reset();
                if(condicaoInput) condicaoInput.value = "";
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                if(filters.condicao && condicaoInput) {
                     condicaoInput.value = filters.condicao;
                     document.querySelector(`.filter-tab[data-val="${filters.condicao}"]`)?.classList.add('active');
                } else {
                     document.querySelector('.filter-tab[data-val=""]')?.classList.add('active');
                }
                for (const [key, value] of Object.entries(filters)) {
                    if(key === 'condicao') continue;
                    const input = form.querySelector(`[name="${key}"]`);
                    if(input && input.type === 'checkbox') {
                        input.checked = value === true || value === "true";
                    } else if(input) {
                        input.value = value;
                    }
                }
                if (filters.marcaId) {
                    fetch(`/Car/GetModelos?marcaId=${filters.marcaId}`).then(r => r.json()).then(data => { setModelos(data, filters.modeloId); fetchResults(1); });
                } else {
                    if(modeloSelect) { modeloSelect.innerHTML = '<option value="">Modelo</option>'; modeloSelect.disabled = true; }
                    fetchResults(1);
                }
            };

            if(btnGuardar) {
                btnGuardar.addEventListener('click', function() {
                    const name = nameInput.value;
                    if (!name) { nameInput.classList.add('is-invalid'); return; } else { nameInput.classList.remove('is-invalid'); }
                    const formData = new FormData(form);
                    const object = {};
                    formData.forEach((value, key) => object[key] = value);
                    if(condicaoInput) object['condicao'] = condicaoInput.value;
                    if(switchReservados) object['ocultarReservados'] = switchReservados.checked;
                    const json = JSON.stringify(object);
                    const data = new FormData();
                    data.append('nome', name);
                    data.append('filtrosJson', json);
                    fetch('/Car/GuardarFiltro', { method: 'POST', body: data }).then(r => r.json()).then(response => {
                        if (response.success) {
                            const modal = bootstrap.Modal.getInstance(document.getElementById('saveFilterModal'));
                            if(modal) modal.hide();
                            loadSavedFiltersList();
                            nameInput.value = "";
                        } else { alert("Erro: " + response.message); }
                    });
                });
            }

            if (searchInput) { searchInput.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => fetchResults(1), 500); }); }
            if (switchReservados) { switchReservados.addEventListener('change', () => fetchResults(1)); }
            form.querySelectorAll('input[type="number"]').forEach(input => { input.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => fetchResults(1), 600); }); });
            if (marcaSelect) {
                marcaSelect.addEventListener('change', function () {
                    const marcaId = this.value;
                    if (!marcaId) { if(modeloSelect) { modeloSelect.innerHTML = '<option value="">Modelo</option>'; modeloSelect.disabled = true; } fetchResults(1); return; }
                    fetch(`/Car/GetModelos?marcaId=${encodeURIComponent(marcaId)}`).then(r => r.json()).then(data => { setModelos(data || []); fetchResults(1); });
                });
            }
            form.querySelectorAll('select:not(#marcaId):not(#modeloId)').forEach(s => { s.addEventListener('change', () => fetchResults(1)); });
            if(modeloSelect) modeloSelect.addEventListener('change', () => fetchResults(1));
            if (sortSelect) sortSelect.addEventListener('change', () => fetchResults(1));

            function attachPaginationEvents() {
                document.querySelectorAll('.ajax-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        fetchResults(this.getAttribute('data-page'));
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                });
            }

            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (condicaoInput) condicaoInput.value = this.getAttribute('data-val');
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    fetchResults(1);
                });
            });

            form.addEventListener('submit', (e) => { e.preventDefault(); fetchResults(1); });
            loadSavedFiltersList();
            if (marcaSelect && marcaSelect.value) { fetch(`/Car/GetModelos?marcaId=${encodeURIComponent(marcaSelect.value)}`).then(r => r.json()).then(d => setModelos(d || [])); }
            attachPaginationEvents();
        })();
    </script>
}