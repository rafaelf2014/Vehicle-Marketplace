@model CliCarProject.Models.Classes.Veiculo

@{
    ViewData["Title"] = "Editar Veículo";
    var imagens = Model.Imagems
        .OrderByDescending(i => i.IdImagem)
        .ToList();
}

<div class="container mt-5">

    <a href="javascript:history.back()" class="btn btn-secondary mb-3">← Voltar</a>

    <h2 class="text-center mb-5" style="font-weight: 700;">
        Editar informações do veículo
    </h2>

    <div class="row g-4">

        <!-- ========================= -->
        <!-- COLUNA ESQUERDA: FORM     -->
        <!-- ========================= -->
        <div class="col-lg-6">

            <form asp-action="Edit" asp-controller="Veiculos" method="post">
                @Html.AntiForgeryToken()

                <input type="hidden" asp-for="IdVeiculo" />

                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                <!-- GRID 2 COLUNAS DENTRO DO FORM -->
                <div class="row g-4">

                    <!-- Ano -->
                    <div class="col-md-6">
                        <label asp-for="Ano" class="form-label fw-semibold">Ano ( Obrigatório )</label>
                        <input asp-for="Ano" class="form-control" />
                        <span asp-validation-for="Ano" class="text-danger"></span>
                    </div>

                    <!-- Marca -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Marca ( Obrigatório )</label>
                        <select asp-for="IdMarca" class="form-control" asp-items="ViewBag.IdMarca">
                            <option value="">Selecionar</option>
                        </select>
                        <span asp-validation-for="IdMarca" class="text-danger"></span>
                    </div>

                    <!-- Modelo -->
                    <div class="col-md-6">
                        <label asp-for="IdModelo" class="form-label fw-semibold">Modelo ( Obrigatório )</label>
                        <select asp-for="IdModelo" class="form-control" asp-items="ViewBag.IdModelo">
                            <option value="">Selecionar</option>
                        </select>
                        <span asp-validation-for="IdModelo" class="text-danger"></span>
                    </div>

                    <!-- Categoria -->
                    <div class="col-md-6">
                        <label asp-for="IdClasse" class="form-label fw-semibold">Categoria ( Obrigatório )</label>
                        <select asp-for="IdClasse" class="form-control" asp-items="ViewBag.IdClasse">
                            <option value="">Selecionar</option>
                        </select>
                        <span asp-validation-for="IdClasse" class="text-danger"></span>
                    </div>

                    <!-- Tipo de caixa -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Caixa ( Obrigatório )</label>
                        <select asp-for="Caixa" class="form-control">
                            <option value="">Selecionar</option>
                            <option value="M">Manual</option>
                            <option value="A">Automático</option>
                        </select>
                        <span asp-validation-for="Caixa" class="text-danger"></span>
                    </div>

                    <!-- Combustível -->
                    <div class="col-md-6">
                        <label asp-for="IdCombustivel" class="form-label fw-semibold">Combustível ( Obrigatório )</label>
                        <select asp-for="IdCombustivel" class="form-control" asp-items="ViewBag.IdCombustivel">
                            <option value="">Selecionar</option>
                        </select>
                        <span asp-validation-for="IdCombustivel" class="text-danger"></span>
                    </div>

                    <!-- Quilómetros -->
                    <div class="col-md-6">
                        <label asp-for="Quilometragem" class="form-label fw-semibold">Quilómetros ( Obrigatório )</label>
                        <div class="input-group">
                            <input asp-for="Quilometragem" class="form-control" />
                            <span class="input-group-text">Km</span>
                        </div>
                        <span asp-validation-for="Quilometragem" class="text-danger"></span>
                    </div>

                    <!-- Estado do Carro -->
                    <div class="col-md-6">
                        <label asp-for="Condicao" class="form-label fw-semibold">Estado do Carro ( Obrigatório )</label>
                        <select asp-for="Condicao" class="form-control">
                            <option value="">Selecionar</option>
                            <option value="N">Novo</option>
                            <option value="S">Seminovo</option>
                            <option value="U">Usado</option>
                        </select>
                        <span asp-validation-for="Condicao" class="text-danger"></span>
                    </div>

                    <!-- Descrição -->
                    <div class="col-md-12">
                        <label class="form-label fw-semibold">Descrição do Veículo ( Opcional )</label>
                        <!-- Se o teu modelo tiver propriedade Descricao, troca por asp-for="Descricao" -->
                        <textarea class="form-control" rows="4"></textarea>
                    </div>

                </div>

                <!-- Botão final -->
                <div class="text-center mt-4 mb-3">
                    <button type="submit" class="btn btn-primary px-5 py-2" style="font-size: 1.1rem;">
                        💾 Guardar alterações
                    </button>
                </div>

            </form>
        </div>

        <!-- ========================= -->
        <!-- COLUNA DIREITA: IMAGENS   -->
        <!-- ========================= -->
        <div class="col-lg-6">

            <div class="card shadow-sm border-0">
                <div class="card-body p-3">

                    <h5 class="mb-3">Imagens do veículo</h5>

                    @if (imagens.Any())
                    {
                        <!-- Carrossel -->
                        <div id="carouselEditVeiculo" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner" style="height:300px;">
                                @for (int i = 0; i < imagens.Count; i++)
                                {
                                    var img = imagens[i];
                                    <div class="carousel-item @(i == 0 ? "active" : "")">
                                        <img src="~/uploads/veiculos/@Model.IdVeiculo/@img.Nome"
                                             class="d-block w-100 rounded"
                                             style="height:300px; object-fit:cover;" />
                                    </div>
                                }
                            </div>

                            <button class="carousel-control-prev" type="button" data-bs-target="#carouselEditVeiculo" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon"></span>
                            </button>

                            <button class="carousel-control-next" type="button" data-bs-target="#carouselEditVeiculo" data-bs-slide="next">
                                <span class="carousel-control-next-icon"></span>
                            </button>
                        </div>

                        <!-- Miniaturas -->
                        <div class="d-flex gap-2 mt-2 flex-wrap">
                            @foreach (var img in imagens)
                            {
                                <img src="~/uploads/veiculos/@Model.IdVeiculo/@img.Nome"
                                     class="rounded"
                                     style="width:90px; height:60px; object-fit:cover; cursor:pointer;"
                                     data-bs-target="#carouselEditVeiculo"
                                     data-bs-slide-to="@imagens.IndexOf(img)" />
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Este veículo ainda não tem imagens.</p>
                    }

                    <!-- Botão para abrir modal de edição de imagens -->
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#modalEditarImagens">
                            Editar Imagens
                        </button>
                    </div>

                </div>
            </div>

        </div>

    </div>

</div>

<!-- ========================= -->
<!-- MODAL: EDITAR IMAGENS     -->
<!-- ========================= -->
<div class="modal fade" id="modalEditarImagens" tabindex="-1" aria-labelledby="modalEditarImagensLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarImagensLabel">Editar Imagens do Veículo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <form asp-action="EditImages" asp-controller="Veiculos" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()

                <input type="hidden" name="id" value="@Model.IdVeiculo" />

                <div class="modal-body">

                    @if (imagens.Any())
                    {
                        <h6>Imagens atuais</h6>
                        <div class="row g-3 mb-4">
                            @foreach (var img in imagens)
                            {
                                <div class="col-md-4">
                                    <div class="border rounded p-2 h-100">
                                        <img src="~/uploads/veiculos/@Model.IdVeiculo/@img.Nome"
                                             class="img-fluid rounded mb-2"
                                             style="height:120px; width:100%; object-fit:cover;" />

                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="RemoverIds" value="@img.IdImagem" id="rem_@img.IdImagem" />
                                            <label class="form-check-label" for="rem_@img.IdImagem">
                                                Remover
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Ainda não existem imagens para este veículo.</p>
                    }

                    <hr />

                    <h6>Adicionar novas imagens</h6>
                    <input type="file" name="NovasImagens" id="inputNovasImagens" multiple accept="image/*" class="form-control" />

                    <div id="previewNovasImagens" class="mt-3 d-flex flex-wrap gap-3"></div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar alterações de imagens</button>
                </div>

            </form>
            
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Preview das novas imagens no modal
        document.getElementById("inputNovasImagens")?.addEventListener("change", function () {
            const previewContainer = document.getElementById("previewNovasImagens");
            previewContainer.innerHTML = "";

            const files = this.files;
            if (!files || files.length === 0) return;

            for (let i = 0; i < files.length; i++) {
                if (!files[i].type.startsWith("image/")) continue;

                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.createElement("img");
                    img.src = e.target.result;
                    img.style.width = "100px";
                    img.style.height = "100px";
                    img.style.objectFit = "cover";
                    img.style.borderRadius = "8px";
                    img.style.boxShadow = "0 0 4px rgba(0,0,0,0.2)";
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(files[i]);
            }
        });
    </script>
}
