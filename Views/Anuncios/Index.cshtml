@model IEnumerable<CliCarProject.Models.Classes.Anuncio>

@{
    ViewData["Title"] = "Explorar Anúncios";
}

@Html.AntiForgeryToken()

<div class="container py-5">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-5 gap-3">
        <div>
            <h2 class="fw-bold mb-0">🚀 Explorar Anúncios</h2>
            <p class="text-muted">Encontre as melhores oportunidades do mercado.</p>
        </div>

        <div class="d-flex gap-2">
            <form method="get" class="m-0">
                <select name="sortOrder" class="form-select rounded-pill shadow-sm" onchange="this.form.submit()" style="min-width: 200px;">
                    <option value="">Ordenar por...</option>
                    <option value="ano_desc">Ano (Mais recentes)</option>
                    <option value="ano_asc">Ano (Mais antigos)</option>
                    <option value="data_desc">Mais recentes no site</option>
                </select>
            </form>
            @if (User.IsInRole("Vendedor"))
            {
                <a asp-action="Create" class="btn btn-primary rounded-pill px-4 shadow-sm">
                    <i class="bi bi-plus-lg me-2"></i>Criar Anúncio
                </a>
            }
        </div>
    </div>

    <div id="selection-toolbar" class="alert alert-dark border-0 shadow rounded-4 p-3 mb-4 d-flex justify-content-between align-items-center d-none animate-fade-in">
        <div class="d-flex align-items-center">
            <i class="bi bi-megaphone-fill fs-4 me-3 text-warning"></i>
            <span class="fw-bold"><span id="selected-count">0</span> Anúncios selecionados</span>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-light rounded-pill btn-sm px-3" onclick="deselectAll()">Desmarcar Todos</button>
            <button type="button" class="btn btn-danger rounded-pill btn-sm px-3" onclick="deleteSelectedAnuncios()">
                <i class="bi bi-trash me-2"></i>Eliminar Selecionados
            </button>
        </div>
    </div>

    @if (!Model.Any())
    {
        <div class="text-center py-5 border rounded-4 bg-light shadow-sm">
            <i class="bi bi-search display-1 text-muted opacity-25"></i>
            <h3 class="mt-4 fw-bold text-secondary">Nenhum anúncio disponível</h3>
        </div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 g-4" id="anuncios-list">
            @foreach (var anuncio in Model)
            {
                var veiculo = anuncio.IdVeiculoNavigation;
                var capa = veiculo?.Imagems?.OrderByDescending(i => i.IdImagem).FirstOrDefault();
                var imagemUrl = capa != null
                ? Url.Content($"~/uploads/veiculos/{veiculo.IdVeiculo}/{capa.Nome}")
                : Url.Content("~/images/Image_not_available.png");

                // Verifica se o utilizador logado é o dono do anúncio
                bool isOwner = User.Identity.Name == anuncio.IdVendedorNavigation?.UserName;

                <div class="col animate-fade-in">
                    @* A classe 'owner-card' permite a seleção apenas nos teus anúncios *@
                    <div class="card h-100 border-0 shadow-sm premium-card rounded-4 overflow-hidden position-relative @(isOwner ? "owner-card" : "")">

                        @if (isOwner)
                        {
                            <div class="position-absolute top-0 start-0 m-3" style="z-index: 10;">
                                <input type="checkbox" class="form-check-input anuncio-checkbox border-primary shadow-sm"
                                       value="@anuncio.IdAnuncio" style="transform: scale(1.4); cursor: pointer;">
                            </div>
                        }

                        <div class="price-badge">@anuncio.Preco.ToString("N0") €</div>

                        <div class="card-img-wrapper">
                            <img src="@imagemUrl" class="card-img-top" onerror="this.src='/images/Image_not_available.png'" alt="Carro" />
                        </div>

                        <div class="card-body p-3">
                            <h6 class="fw-bold text-truncate mb-1">@anuncio.Titulo</h6>
                            <p class="small text-muted mb-2">
                                <i class="bi bi-geo-alt me-1 text-primary"></i>
                                @(anuncio.IdLocalizacaoNavigation?.Distrito ?? "Portugal")
                            </p>

                            <div class="d-flex justify-content-between border-top pt-2 mt-2 small text-muted">
                                <span><i class="bi bi-calendar3 me-1 text-primary"></i> @veiculo?.Ano</span>
                                <span><i class="bi bi-speedometer2 me-1 text-primary"></i> @veiculo?.Quilometragem?.ToString("N0") km</span>
                            </div>
                        </div>

                        <div class="card-footer bg-white border-0 p-3 pt-0">
                            <a asp-action="Details" asp-route-id="@anuncio.IdAnuncio" class="btn btn-dark w-100 rounded-pill btn-sm py-2 btn-details">
                                Ver Detalhes
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    /* Estilos herdados da Garagem */
    .premium-card {
        transition: all 0.3s ease;
        border: 2px solid transparent !important;
        user-select: none;
    }

    .owner-card {
        cursor: pointer;
    }

    .premium-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }

    .card-selected {
        border: 2px solid #0d6efd !important;
        background-color: #f0f7ff !important;
    }

    .card-img-wrapper {
        height: 160px;
        overflow: hidden;
    }

    .card-img-top {
        height: 100%;
        width: 100%;
        object-fit: cover;
    }

    .price-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: #0d6efd;
        color: white;
        padding: 2px 10px;
        border-radius: 50px;
        font-weight: bold;
        font-size: 0.8rem;
        z-index: 5;
    }

    .owner-badge {
        position: absolute;
        bottom: 100px;
        left: 12px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.65rem;
        text-transform: uppercase;
        z-index: 5;
    }

    .animate-fade-in {
        animation: fadeIn 0.4s ease forwards;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }
</style>

@section Scripts {
    <script>
        // Lógica de seleção unificada
        document.getElementById('anuncios-list').addEventListener('click', function (e) {
            // Se o clique for no botão de detalhes, ignora a seleção
            if (e.target.closest('.btn-details')) return;

            // Só permite seleção se o card for 'owner-card' (do próprio utilizador)
            const card = e.target.closest('.owner-card');
            if (!card) return;

            const checkbox = card.querySelector('.anuncio-checkbox');
            if (checkbox) {
                if (e.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                }
                card.classList.toggle('card-selected', checkbox.checked);
                updateToolbar();
            }
        });

        function updateToolbar() {
            const selectedCount = document.querySelectorAll('.anuncio-checkbox:checked').length;
            const toolbar = document.getElementById('selection-toolbar');
            const countSpan = document.getElementById('selected-count');

            if (selectedCount > 0) {
                toolbar.classList.remove('d-none');
                countSpan.innerText = selectedCount;
            } else {
                toolbar.classList.add('d-none');
            }
        }

        function deselectAll() {
            document.querySelectorAll('.anuncio-checkbox:checked').forEach(cb => {
                cb.checked = false;
                cb.closest('.card').classList.remove('card-selected');
            });
            updateToolbar();
        }

        async function deleteSelectedAnuncios() {
            const selectedCheckboxes = document.querySelectorAll('.anuncio-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));

            if (!confirm(`Tem a certeza que deseja eliminar permanentemente estes ${selectedIds.length} anúncios?`)) return;

            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

            const response = await fetch('/Anuncios/DeleteMultiple', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify(selectedIds)
            });

            if (response.ok) {
                selectedCheckboxes.forEach(cb => {
                    const col = cb.closest('.col');
                    col.style.opacity = '0';
                    setTimeout(() => col.remove(), 300);
                });
                setTimeout(updateToolbar, 350);
            } else {
                alert("Erro ao eliminar. Certifique-se de que é o dono destes anúncios.");
            }
        }
    </script>
}