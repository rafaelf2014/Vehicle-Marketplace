@model CliCarProject.Models.AdminDashboardViewModel
@{
    ViewData["Title"] = "Painel de Controlo";
    Layout = "_Layout";
}

<div class="container py-5">
    <div class="row g-4">
        <aside class="col-12 col-md-4 col-lg-3">
            @{
                // Renderiza a partial da sidebar (usa ViewData["AdminActive"] definida no controller)
                await Html.RenderPartialAsync("~/Views/Admin/_AdminSidebar.cshtml");
            }
        </aside>

        <main class="col-12 col-md-8 col-lg-9">
            <div class="card shadow-sm rounded-4 p-4">
                <h2 class="fw-bold mb-2">Visão Geral</h2>
                <p class="text-muted">Bem‑vindo ao painel administrativo. Use a barra lateral para navegar entre as secções.</p>
                <!-- Estatísticas rápidas abaixo de "Visão Geral" -->
                <div class="row g-3">

                    <div class="col-12 col-sm-6 col-lg">
                        <div class="d-flex align-items-center border rounded-3 p-3 h-100">
                            <div class="me-3">
                                <i class="bi bi-eye fs-3 text-primary"></i>
                            </div>
                            <div>
                                <div class="small text-muted">Visitas totais</div>
                                <div class="h5 mb-0">@((Model?.TotalSiteVisits) ?? 0)</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-sm-6 col-lg">
                        <div class="d-flex align-items-center border rounded-3 p-3 h-100">
                            <div class="me-3">
                                <i class="bi bi-person-lines-fill fs-3 text-secondary"></i>
                            </div>
                            <div>
                                <div class="small text-muted">Contas criadas</div>
                                <div class="h5 mb-0">@((Model?.TotalAccountsCreated) ?? 0)</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-sm-6 col-lg">
                        <div class="d-flex align-items-center border rounded-3 p-3 h-100">
                            <div class="me-3">
                                <i class="bi bi-card-list fs-3 text-success"></i>
                            </div>
                            <div>
                                <div class="small text-muted">Anúncios</div>
                                <div class="h5 mb-0">@((Model?.TotalAnuncios) ?? 0)</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-sm-6 col-lg">
                        <div class="d-flex align-items-center border rounded-3 p-3 h-100">
                            <div class="me-3">
                                <i class="bi bi-calendar-week fs-3 text-warning"></i>
                            </div>
                            <div>
                                <div class="small text-muted">Visitas semanais</div>
                                <div class="h5 mb-0">@((Model?.WeeklySiteVisits) ?? 0)</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-sm-6 col-lg">
                        <div class="d-flex align-items-center border rounded-3 p-3 h-100">
                            <div class="me-3">
                                <i class="bi bi-cash-stack fs-3 text-success"></i>
                            </div>
                            <div>
                                <div class="small text-muted">Vendas totais</div>
                                <div class="h5 mb-0">@((Model?.TotalVendas) ?? 0)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de visitas ao longo do tempo -->
                <div class="mt-4">
                    <h6 class="mb-2">Visitas (últimos 30 dias)</h6>
                    <div class="card border-0">
                        <div class="card-body">
                            <canvas id="visitsChart" style="max-height:360px;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de vendas ao longo do tempo -->
                <div class="mt-4">
                    <h6 class="mb-2">Vendas (últimos 30 dias)</h6>
                    <div class="card border-0">
                        <div class="card-body">
                            <canvas id="salesChart" style="max-height:360px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

@if (TempData["AdminSuccess"] is string ok && !string.IsNullOrWhiteSpace(ok))
{
    <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
        @ok
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
    </div>
}

@if (TempData["AdminError"] is string err && !string.IsNullOrWhiteSpace(err))
{
    <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
        @err
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
    </div>
}

<style>
    .list-group-item i { width: 1.25rem; text-align: center; }
    .rounded-4 { border-radius: 1.0rem !important; }
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    (function () {
        const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model?.VisitLabels ?? new System.Collections.Generic.List<string>()));
        const data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model?.VisitCounts ?? new System.Collections.Generic.List<int>()));

        const ctx = document.getElementById('visitsChart').getContext('2d');

        // Se já existir uma instância anterior (hot reload), destrói
        if (window._visitsChart) {
            window._visitsChart.destroy();
        }

        window._visitsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitas por dia',
                    data: data,
                    borderColor: 'rgba(13,110,253,0.9)', // primary
                    backgroundColor: 'rgba(13,110,253,0.12)',
                    fill: true,
                    tension: 0.25,
                    pointRadius: 2,
                    pointHoverRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: { maxRotation: 0, autoSkip: true },
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.04)' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
    })();

    (function () {
        const salesLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model?.SalesLabels ?? new System.Collections.Generic.List<string>()));
        const salesData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model?.SalesCounts ?? new System.Collections.Generic.List<int>()));

        const ctx = document.getElementById('salesChart').getContext('2d');

        // Se já existir uma instância anterior (hot reload), destrói
        if (window._salesChart) {
            window._salesChart.destroy();
        }

        window._salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: salesLabels,
                datasets: [{
                    label: 'Vendas por dia',
                    data: salesData,
                    borderColor: 'rgba(40,167,69,0.9)', // success
                    backgroundColor: 'rgba(40,167,69,0.12)',
                    fill: true,
                    tension: 0.25,
                    pointRadius: 2,
                    pointHoverRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: { maxRotation: 0, autoSkip: true },
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.04)' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
    })();
</script>