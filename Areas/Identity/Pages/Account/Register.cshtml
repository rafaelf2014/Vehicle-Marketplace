@page
@model RegisterModel
@{
    ViewData["Title"] = "Criar Nova Conta";
    var initialRole = Model?.Input?.Role ?? (string.IsNullOrEmpty(Request.Query["role"]) ? "Comprador" : Request.Query["role"].ToString());
}

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-5">
            <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                
                <div class="card-header bg-danger text-white text-center py-4">
                    <h1 class="fw-bold mb-0">CliCar</h1>
                    <p class="mb-0 opacity-75">O teu próximo carro está aqui</p>
                </div>

                <div class="card-body p-4 p-md-5">
                    <h4 class="text-center mb-4 text-dark fw-bold">@ViewData["Title"]</h4>

                    <div class="tabs-container mb-4 text-center">
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-danger py-2 @(initialRole == "Comprador" ? "active" : "")" data-role="Comprador">Comprador</button>
                            <button type="button" class="btn btn-outline-danger py-2 @(initialRole == "Vendedor" ? "active" : "")" data-role="Vendedor">Vendedor</button>
                        </div>
                    </div>

                    <form id="registerForm" asp-route-returnUrl="@(Model?.ReturnUrl ?? string.Empty)" method="post">
                        <input type="hidden" id="roleInput" name="Input.Role" value="@initialRole" />
                        
                        <div asp-validation-summary="ModelOnly" class="text-danger small mb-3" role="alert"></div>

                        <div class="form-floating mb-3">
                            <input asp-for="Input.UserName" class="form-control" placeholder="username" />
                            <label asp-for="Input.UserName">Username</label>
                            <span asp-validation-for="Input.UserName" class="text-danger small"></span>
                        </div>

                        <div class="form-floating mb-3">
                            <input asp-for="Input.Email" class="form-control" placeholder="email" />
                            <label asp-for="Input.Email">Email</label>
                            <span asp-validation-for="Input.Email" class="text-danger small"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input asp-for="Input.PhoneNumber" class="form-control" placeholder="912..." />
                                    <label asp-for="Input.PhoneNumber">Telemóvel</label>
                                    <span asp-validation-for="Input.PhoneNumber" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input asp-for="Input.CodigoPostal" class="form-control" placeholder="0000-000" />
                                    <label asp-for="Input.CodigoPostal">Cód. Postal</label>
                                    <span asp-validation-for="Input.CodigoPostal" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>

                        <div id="roleFields" class="bg-light rounded p-2 mb-3 border-start border-danger border-4"></div>

                        <div class="form-floating mb-3">
                            <input asp-for="Input.Password" class="form-control" autocomplete="new-password" placeholder="password" />
                            <label asp-for="Input.Password">Palavra-passe</label>
                            <span asp-validation-for="Input.Password" class="text-danger small"></span>
                        </div>

                        <div class="form-floating mb-4">
                            <input asp-for="Input.ConfirmPassword" class="form-control" autocomplete="new-password" placeholder="confirm" />
                            <label asp-for="Input.ConfirmPassword">Confirmar Palavra-passe</label>
                            <span asp-validation-for="Input.ConfirmPassword" class="text-danger small"></span>
                        </div>

                        <button type="submit" class="w-100 btn btn-lg btn-danger shadow fw-bold py-3">CRIAR CONTA</button>
                    </form>

                    <div class="text-center mt-4">
                        <p class="small text-muted">Já tem conta? <a asp-page="/Account/Login" class="text-danger fw-bold text-decoration-none">Inicie sessão</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<template id="comprador-template">
    <div class="form-floating mb-3">
        <input asp-for="Input.Morada" class="form-control" placeholder="morada" />
        <label asp-for="Input.Morada"></label>
        <span asp-validation-for="Input.Morada" class="text-danger small"></span>
    </div>
</template>

<template id="vendedor-template">
    <div class="form-floating mb-3">
        <input asp-for="Input.NIF" class="form-control" placeholder="nif" />
        <label asp-for="Input.NIF"></label>
        <span asp-validation-for="Input.NIF" class="text-danger small"></span>
    </div>
    <div class="mb-3">
        <label asp-for="Input.TypeSeller" class="form-label small fw-bold px-2">Tipo de Vendedor</label>
        <select asp-for="Input.TypeSeller" class="form-select">
            <option value="">-- Selecione --</option>
            <option value="P">Particular</option>
            <option value="C">Comercial</option>
        </select>
        <span asp-validation-for="Input.TypeSeller" class="text-danger small"></span>
    </div>
</template>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            const tabs = document.querySelectorAll('.tabs-container button[data-role]');
            const roleInput = document.getElementById('roleInput');
            const roleFields = document.getElementById('roleFields');
            const compradorTpl = document.getElementById('comprador-template');
            const vendedorTpl = document.getElementById('vendedor-template');

            function clearRoleFields() {
                while (roleFields.firstChild) roleFields.removeChild(roleFields.firstChild);
            }

            function injectTemplate(template) {
                clearRoleFields();
                if (!template) return;
                const clone = template.content.cloneNode(true);
                roleFields.appendChild(clone);

                if (window.jQuery && window.jQuery.validator && window.jQuery.validator.unobtrusive) {
                    window.jQuery.validator.unobtrusive.parse($('#registerForm'));
                }
            }

            function setRole(role, pushUrl = true) {
                tabs.forEach(t => {
                    if (t.dataset.role === role) {
                        t.classList.add('active');
                        t.classList.replace('btn-outline-danger', 'btn-danger');
                    } else {
                        t.classList.remove('active');
                        t.classList.replace('btn-danger', 'btn-outline-danger');
                    }
                });

                roleInput.value = role;

                if (role === 'Vendedor') injectTemplate(vendedorTpl);
                else injectTemplate(compradorTpl);

                if (pushUrl) {
                    const url = new URL(window.location);
                    url.searchParams.set('role', role);
                    window.history.replaceState({}, '', url);
                }
            }

            tabs.forEach(tab => tab.addEventListener('click', function () {
                setRole(this.dataset.role, true);
            }));

            setRole('@initialRole', 'Comprador');
        })();
    </script>
}